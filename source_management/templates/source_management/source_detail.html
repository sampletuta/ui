{% extends 'base.html' %}

{% block title %}{{ source.name }} - {{ source_type|title }} Source{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-12">
            <div class="bg-secondary rounded h-100 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h6 class="mb-0">
                        <i class="fa fa-{% if source_type == 'camera' %}video-camera{% elif source_type == 'file' %}file-video{% elif source_type == 'stream' %}broadcast-tower{% else %}video{% endif %} me-2"></i>
                        {{ source.name }}
                    </h6>
                    <div class="d-flex gap-2">
                        <a href="{% url 'source_management:source_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fa fa-arrow-left me-2"></i>Back to Sources
                        </a>
                        <a href="{% url 'source_management:'|add:source_type|add:'_update' source.source_id %}" class="btn btn-primary btn-sm">
                            <i class="fa fa-edit me-2"></i>Edit
                        </a>
                    </div>
                </div>

                <!-- Source Information -->
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="bg-dark rounded p-4">
                            <h6 class="mb-4 text-primary">
                                <i class="fa fa-info-circle me-2"></i>Source Details
                            </h6>
                            
                            <div class="table-responsive">
                                <table class="table table-borderless text-white">
                                    <tbody>
                                        <tr>
                                            <td><strong>Source ID:</strong></td>
                                            <td><code class="text-info">{{ source.source_id }}</code></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Name:</strong></td>
                                            <td>{{ source.name }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Type:</strong></td>
                                            <td>
                                                {% if source_type == 'camera' %}
                                                    <span class="badge bg-primary">Camera</span>
                                                {% elif source_type == 'file' %}
                                                    <span class="badge bg-success">File</span>
                                                {% elif source_type == 'stream' %}
                                                    <span class="badge bg-info">Stream</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Status:</strong></td>
                                            <td>
                                                {% if source.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% if source.description %}
                                        <tr>
                                            <td><strong>Description:</strong></td>
                                            <td>{{ source.description }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if source.location %}
                                        <tr>
                                            <td><strong>Location:</strong></td>
                                            <td>{{ source.location }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if source.zone %}
                                        <tr>
                                            <td><strong>Zone:</strong></td>
                                            <td>{{ source.zone }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <td><strong>Created:</strong></td>
                                            <td>{{ source.created_at|date:"F d, Y H:i" }}</td>
                                        </tr>
                                        {% if source.updated_at %}
                                        <tr>
                                            <td><strong>Last Updated:</strong></td>
                                            <td>{{ source.updated_at|date:"F d, Y H:i" }}</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Source Type Specific Information -->
                            {% if source_type == 'camera' %}
                            <div class="mt-4">
                                <h6 class="mb-3 text-primary">
                                    <i class="fa fa-video-camera me-2"></i>Camera Configuration
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-borderless text-white">
                                        <tbody>
                                            <tr>
                                                <td><strong>IP Address:</strong></td>
                                                <td><code class="text-info">{{ source.camera_ip }}</code></td>
                                            </tr>
                                            {% if source.camera_port %}
                                            <tr>
                                                <td><strong>Port:</strong></td>
                                                <td>{{ source.camera_port }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_protocol %}
                                            <tr>
                                                <td><strong>Protocol:</strong></td>
                                                <td>{{ source.camera_protocol }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_username %}
                                            <tr>
                                                <td><strong>Username:</strong></td>
                                                <td>{{ source.camera_username }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_type %}
                                            <tr>
                                                <td><strong>Camera Type:</strong></td>
                                                <td>{{ source.camera_type }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_resolution %}
                                            <tr>
                                                <td><strong>Resolution:</strong></td>
                                                <td>{{ source.camera_resolution }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_fps %}
                                            <tr>
                                                <td><strong>Frame Rate:</strong></td>
                                                <td>{{ source.camera_fps }} FPS</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}

                            {% if source_type == 'file' %}
                            <div class="mt-4">
                                <h6 class="mb-3 text-primary">
                                    <i class="fa fa-file-video me-2"></i>File Information
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-borderless text-white">
                                        <tbody>
                                            <tr>
                                                <td><strong>Original Filename:</strong></td>
                                                <td><code class="text-info">{{ source.original_filename|default:"Not specified" }}</code></td>
                                            </tr>
                                            <tr>
                                                <td><strong>File Size:</strong></td>
                                                <td>{{ source.get_file_size_display|default:"Not specified" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>File Format:</strong></td>
                                                <td>{{ source.file_format|default:"Not specified" }}</td>
                                            </tr>
                                            {% if source.access_token %}
                                            <tr>
                                                <td><strong>Access Token:</strong></td>
                                                <td><code class="text-info">{{ source.access_token }}</code></td>
                                            </tr>
                                            {% endif %}
                                            {% if source.status %}
                                            <tr>
                                                <td><strong>Processing Status:</strong></td>
                                                <td>
                                                    {% if source.status == 'ready' %}
                                                        <span class="badge bg-success">Ready</span>
                                                    {% elif source.status == 'processing' %}
                                                        <span class="badge bg-warning">Processing</span>
                                                    {% elif source.status == 'failed' %}
                                                        <span class="badge bg-danger">Failed</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ source.status|title }}</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}

                            {% if source_type == 'stream' %}
                            <div class="mt-4">
                                <h6 class="mb-3 text-primary">
                                    <i class="fa fa-broadcast-tower me-2"></i>Stream Configuration
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-borderless text-white">
                                        <tbody>
                                            <tr>
                                                <td><strong>Stream URL:</strong></td>
                                                <td><code class="text-info">{{ source.stream_url }}</code></td>
                                            </tr>
                                            {% if source.stream_protocol %}
                                            <tr>
                                                <td><strong>Protocol:</strong></td>
                                                <td>{{ source.stream_protocol }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.stream_quality %}
                                            <tr>
                                                <td><strong>Quality:</strong></td>
                                                <td>{{ source.stream_quality }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.stream_parameters %}
                                            <tr>
                                                <td><strong>Parameters:</strong></td>
                                                <td><code class="text-info">{{ source.stream_parameters }}</code></td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <!-- Location Information -->
                        {% if source.latitude and source.longitude %}
                        <div class="bg-dark rounded p-4 mb-4">
                            <h6 class="mb-4 text-primary">
                                <i class="fa fa-map me-2"></i>Location
                            </h6>
                            <div class="text-center">
                                <i class="fa fa-map fa-2x text-primary mb-2"></i>
                                <p class="text-muted mb-2">Coordinates</p>
                                <p class="mb-2">
                                    <strong>Lat:</strong> {{ source.latitude|floatformat:6 }}<br>
                                    <strong>Lng:</strong> {{ source.longitude|floatformat:6 }}
                                </p>
                                <a href="https://maps.google.com/?q={{ source.latitude }},{{ source.longitude }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fa fa-external-link-alt me-2"></i>View on Map
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Quick Actions -->
                        <div class="bg-dark rounded p-4">
                            <h6 class="mb-4 text-primary">
                                <i class="fa fa-bolt me-2"></i>Quick Actions
                            </h6>
                            <div class="d-grid gap-2">
                                {% if source_type == 'file' and source.status == 'ready' %}
                                <a href="{% url 'video_player:source_video_detail' source.source_id %}" class="btn btn-success">
                                    <i class="fa fa-play me-2"></i>Play Video
                                </a>
                                {% elif source_type == 'camera' and source.is_active %}
                                <a href="{% url 'video_player:source_video_detail' source.source_id %}" class="btn btn-success">
                                    <i class="fa fa-video me-2"></i>View Live Stream
                                </a>
                                {% elif source_type == 'stream' %}
                                <a href="{% url 'video_player:source_video_detail' source.source_id %}" class="btn btn-success">
                                    <i class="fa fa-broadcast-tower me-2"></i>View Stream
                                </a>
                                {% endif %}
                                <a href="{% url 'source_management:'|add:source_type|add:'_update' source.source_id %}" class="btn btn-primary">
                                    <i class="fa fa-edit me-2"></i>Edit Source
                                </a>
                                <button type="button" class="btn btn-danger" onclick="showDeleteConfirmation()">
                                    <i class="fa fa-trash me-2"></i>Delete Source
                                </button>
                            </div>
                        </div>

                        <!-- Stream Processor Service Status -->
                        {% if source_type in 'camera,stream' and processor_status %}
                        <div class="bg-dark rounded p-4 mt-4">
                            <h6 class="mb-4 text-primary">
                                <i class="fa fa-cogs me-2"></i>Stream Processor Service
                            </h6>
                            {% if processor_status.success %}
                                <div class="text-success mb-2">
                                    <i class="fa fa-check-circle me-2"></i>Connected
                                </div>
                                {% if processor_status.data %}
                                    <div class="small text-muted">
                                        <div><strong>Status:</strong> {{ processor_status.data.status|default:"Unknown" }}</div>
                                        {% if processor_status.data.topic_name %}
                                        <div><strong>Topic:</strong> {{ processor_status.data.topic_name }}</div>
                                        {% endif %}
                                        {% if processor_status.data.frames_ingested is not None %}
                                        <div><strong>Frames:</strong> {{ processor_status.data.frames_ingested }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                
                                <!-- Stream Control Buttons -->
                                <div class="mt-3">
                                    <div class="d-grid gap-2">
                                        {% if processor_status.data.status == 'running' %}
                                            <button class="btn btn-warning btn-sm" onclick="stopStream('{{ source.source_id }}')">
                                                <i class="fa fa-stop me-2"></i>Stop Stream
                                            </button>
                                        {% else %}
                                            <button class="btn btn-success btn-sm" onclick="startStream('{{ source.source_id }}')">
                                                <i class="fa fa-play me-2"></i>Start Stream
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-outline-primary btn-sm" onclick="submitStream('{{ source.source_id }}')">
                                            <i class="fa fa-paper-plane me-2"></i>Submit Stream Data
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="refreshStreamStatus('{{ source.source_id }}')">
                                            <i class="fa fa-refresh me-2"></i>Refresh Status
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="openComprehensiveSubmission('{{ source.source_id }}')">
                                            <i class="fa fa-cogs me-2"></i>Comprehensive Submission
                                        </button>
                                    </div>
                                </div>
                            {% elif processor_status.not_found %}
                                <div class="text-info mb-2">
                                    <i class="fa fa-info-circle me-2"></i>Not Registered
                                </div>
                                <div class="small text-muted mb-3">
                                    This source is not yet registered with the stream processor service.
                                </div>
                                <div class="mt-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary btn-sm" onclick="createStream('{{ source.source_id }}')">
                                            <i class="fa fa-plus me-2"></i>Register with Processor Service
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="submitStream('{{ source.source_id }}')">
                                            <i class="fa fa-paper-plane me-2"></i>Submit Stream Data
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="openComprehensiveSubmission('{{ source.source_id }}')">
                                            <i class="fa fa-cogs me-2"></i>Comprehensive Submission
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-warning mb-2">
                                    <i class="fa fa-exclamation-triangle me-2"></i>Connection Failed
                                </div>
                                <div class="small text-muted">
                                    {{ processor_status.error|default:"Unknown error" }}
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-info btn-sm" onclick="refreshStreamStatus('{{ source.source_id }}')">
                                        <i class="fa fa-refresh me-2"></i>Retry Connection
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stream Submission Modal -->
<div class="modal fade" id="streamSubmissionModal" tabindex="-1" aria-labelledby="streamSubmissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="streamSubmissionModalLabel">Stream Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="submissionStatus">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Submitting stream data...</p>
                    </div>
                </div>
                <div id="submissionResult" style="display: none;">
                    <div id="successResult" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fa fa-check-circle me-2"></i>
                            <span id="successMessage"></span>
                        </div>
                    </div>
                    <div id="errorResult" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="fa fa-exclamation-circle me-2"></i>
                            <span id="errorMessage"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalBtn">Close</button>
                <button type="button" class="btn btn-primary" id="refreshPageBtn" style="display: none;">Refresh Page</button>
            </div>
        </div>
    </div>
</div>

<!-- Comprehensive Stream Submission Modal -->
<div class="modal fade" id="comprehensiveSubmissionModal" tabindex="-1" aria-labelledby="comprehensiveSubmissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="comprehensiveSubmissionModalLabel">
                    <i class="fa fa-cogs me-2"></i>Comprehensive Stream Submission
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="comprehensiveSubmissionForm">
                    <div class="row g-3">
                        <!-- Basic Configuration -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-cog me-2"></i>Basic Configuration</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Stream ID</label>
                                        <input type="text" class="form-control" id="stream_id" readonly>
                                        <div class="form-text">Unique identifier for this stream</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Source URL</label>
                                        <input type="text" class="form-control" id="source_url" readonly>
                                        <div class="form-text">Source URL (auto-generated)</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Topic Name</label>
                                        <input type="text" class="form-control" id="topic_name" readonly>
                                        <div class="form-text">Topic for downstream subscription</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">External Service ID</label>
                                        <input type="text" class="form-control" id="external_service_id" value="django-source-management">
                                        <div class="form-text">Identifier for external service</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Processing Parameters -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-film me-2"></i>Processing Parameters</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Target FPS</label>
                                        <input type="number" class="form-control" id="target_fps" step="0.1" min="0.1" max="300" value="1.0">
                                        <div class="form-text">Target frame rate (0.1-300 FPS)</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Frame Quality</label>
                                        <input type="number" class="form-control" id="frame_quality" min="1" max="100" value="85">
                                        <div class="form-text">Frame quality (1-100)</div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="resize_enabled">
                                            <label class="form-check-label" for="resize_enabled">
                                                Enable Frame Resizing
                                            </label>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">Target Width</label>
                                            <input type="number" class="form-control" id="target_width" min="1" max="7680" disabled>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Target Height</label>
                                            <input type="number" class="form-control" id="target_height" min="1" max="4320" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Authentication -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-lock me-2"></i>Authentication</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Username</label>
                                        <input type="text" class="form-control" id="username" placeholder="Optional">
                                        <div class="form-text">Username for authentication</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Password</label>
                                        <input type="password" class="form-control" id="password" placeholder="Optional">
                                        <div class="form-text">Password for authentication</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Audio Configuration -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-volume-up me-2"></i>Audio Configuration</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enable_audio">
                                            <label class="form-check-label" for="enable_audio">
                                                Enable Audio Processing
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Audio Codec</label>
                                        <input type="text" class="form-control" id="audio_codec" placeholder="e.g., aac, mp3, opus" disabled>
                                        <div class="form-text">Audio codec for processing</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">Audio Channels</label>
                                            <input type="number" class="form-control" id="audio_channels" min="1" max="8" value="1" disabled>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Sample Rate (Hz)</label>
                                            <input type="number" class="form-control" id="audio_sample_rate" min="8000" max="192000" value="16000" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Network & Performance -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-network-wired me-2"></i>Network & Performance</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">Buffer Size (ms)</label>
                                            <input type="number" class="form-control" id="buffer_size" min="100" max="10000" value="1000">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Timeout (s)</label>
                                            <input type="number" class="form-control" id="timeout" min="5" max="300" value="30">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-6">
                                            <label class="form-label">Retry Attempts</label>
                                            <input type="number" class="form-control" id="retry_attempts" min="0" max="10" value="3">
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="keepalive" checked>
                                                <label class="form-check-label" for="keepalive">
                                                    Keepalive Connections
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Custom Metadata -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fa fa-tags me-2"></i>Custom Metadata</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Additional Metadata (JSON)</label>
                                        <textarea class="form-control" id="custom_metadata" rows="3" placeholder='{"key": "value"}'></textarea>
                                        <div class="form-text">Additional custom metadata as JSON (optional)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Submission Status -->
                <div id="comprehensiveSubmissionStatus" style="display: none;">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Submitting stream to downstream service...</p>
                    </div>
                </div>
                
                <!-- Submission Result -->
                <div id="comprehensiveSubmissionResult" style="display: none;">
                    <div id="comprehensiveSuccessResult" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fa fa-check-circle me-2"></i>
                            <span id="comprehensiveSuccessMessage"></span>
                        </div>
                    </div>
                    <div id="comprehensiveErrorResult" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="fa fa-exclamation-circle me-2"></i>
                            <span id="comprehensiveErrorMessage"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeComprehensiveModalBtn">Close</button>
                <button type="button" class="btn btn-primary" id="submitComprehensiveBtn">
                    <i class="fa fa-paper-plane me-2"></i>Submit Stream
                </button>
                <button type="button" class="btn btn-success" id="refreshComprehensivePageBtn" style="display: none;">
                    <i class="fa fa-refresh me-2"></i>Refresh Page
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">
                    <i class="fa fa-exclamation-triangle me-2"></i>Delete Source
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="deleteWarningContent">
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">Warning: This action cannot be undone!</h6>
                        <p class="mb-0">You are about to delete the source <strong>"{{ source.name }}"</strong>.</p>
                    </div>
                    
                    {% if source_type in 'camera,stream' %}
                    <div class="alert alert-info">
                        <h6 class="alert-heading">Stream Processor Service Cleanup</h6>
                        <p class="mb-0">This will also remove the stream from the downstream processor service to stop data ingestion.</p>
                    </div>
                    {% endif %}
                    
                    <p>Are you sure you want to proceed with the deletion?</p>
                </div>
                
                <div id="deleteSuccessContent" style="display: none;">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="fa fa-check-circle me-2"></i>Source Deleted Successfully
                        </h6>
                        <p class="mb-0">The source has been removed from both the database and the stream processor service.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div id="deleteWarningFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="post" action="{% url 'source_management:'|add:source_type|add:'_delete' source.source_id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            <i class="fa fa-trash me-2"></i>Delete Source
                        </button>
                    </form>
                </div>
                <div id="deleteSuccessFooter" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="window.location.href='{% url 'source_management:source_list' %}'">
                        <i class="fa fa-arrow-left me-2"></i>Back to Sources
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stream Control JavaScript -->
{% if source_type in 'camera,stream' %}
<script>
// Reset modal when it's closed
document.getElementById('streamSubmissionModal').addEventListener('hidden.bs.modal', function () {
    // Reset modal title and content
    document.getElementById('streamSubmissionModalLabel').textContent = 'Stream Submission';
    document.querySelector('#submissionStatus p').textContent = 'Submitting stream data...';
    
    // Reset modal state
    document.getElementById('submissionStatus').style.display = 'block';
    document.getElementById('submissionResult').style.display = 'none';
    document.getElementById('closeModalBtn').style.display = 'block';
    document.getElementById('refreshPageBtn').style.display = 'none';
});

function startStream(sourceId) {
    if (confirm('Start video stream processing for this source?')) {
        fetch(`/source-management/api/stream/${sourceId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh to show updated status
            } else {
                alert('Failed to start stream: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting stream. Please try again.');
        });
    }
}

function stopStream(sourceId) {
    if (confirm('Stop video stream processing for this source?')) {
        fetch(`/source-management/api/stream/${sourceId}/stop/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh to show updated status
            } else {
                alert('Failed to stop stream: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error stopping stream. Please try again.');
        });
    }
}

function createStream(sourceId) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('streamSubmissionModal'));
    modal.show();
    
    // Update modal title and content for registration
    document.getElementById('streamSubmissionModalLabel').textContent = 'Stream Registration';
    document.querySelector('#submissionStatus p').textContent = 'Registering with processor service...';
    
    // Reset modal state
    document.getElementById('submissionStatus').style.display = 'block';
    document.getElementById('submissionResult').style.display = 'none';
    document.getElementById('closeModalBtn').style.display = 'block';
    document.getElementById('refreshPageBtn').style.display = 'none';
    
    // Register the stream
    fetch(`/source-management/api/stream/${sourceId}/create/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading status
        document.getElementById('submissionStatus').style.display = 'none';
        document.getElementById('submissionResult').style.display = 'block';
        
        if (data.success) {
            // Show success
            document.getElementById('successResult').style.display = 'block';
            document.getElementById('errorResult').style.display = 'none';
            document.getElementById('successMessage').textContent = data.message || 'Stream registered successfully!';
            document.getElementById('closeModalBtn').style.display = 'none';
            document.getElementById('refreshPageBtn').style.display = 'block';
        } else {
            // Show error
            document.getElementById('successResult').style.display = 'none';
            document.getElementById('errorResult').style.display = 'block';
            document.getElementById('errorMessage').textContent = data.error || 'Unknown error occurred';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Hide loading status
        document.getElementById('submissionStatus').style.display = 'none';
        document.getElementById('submissionResult').style.display = 'block';
        
        // Show error
        document.getElementById('successResult').style.display = 'none';
        document.getElementById('errorResult').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'Network error. Please try again.';
    });
}

function submitStream(sourceId) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('streamSubmissionModal'));
    modal.show();
    
    // Reset modal state
    document.getElementById('submissionStatus').style.display = 'block';
    document.getElementById('submissionResult').style.display = 'none';
    document.getElementById('closeModalBtn').style.display = 'block';
    document.getElementById('refreshPageBtn').style.display = 'none';
    
    // Submit the stream data
    fetch(`/source-management/api/stream/${sourceId}/submit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading status
        document.getElementById('submissionStatus').style.display = 'none';
        document.getElementById('submissionResult').style.display = 'block';
        
        if (data.success) {
            // Show success
            document.getElementById('successResult').style.display = 'block';
            document.getElementById('errorResult').style.display = 'none';
            document.getElementById('successMessage').textContent = data.message || 'Stream data submitted successfully!';
            document.getElementById('closeModalBtn').style.display = 'none';
            document.getElementById('refreshPageBtn').style.display = 'block';
        } else {
            // Show error
            document.getElementById('successResult').style.display = 'none';
            document.getElementById('errorResult').style.display = 'block';
            document.getElementById('errorMessage').textContent = data.error || 'Unknown error occurred';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Hide loading status
        document.getElementById('submissionStatus').style.display = 'none';
        document.getElementById('submissionResult').style.display = 'block';
        
        // Show error
        document.getElementById('successResult').style.display = 'none';
        document.getElementById('errorResult').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'Network error. Please try again.';
    });
}

function refreshStreamStatus(sourceId) {
    // Show loading state
    const statusDiv = document.querySelector('.bg-dark.rounded.p-4.mt-4');
    if (statusDiv) {
        statusDiv.innerHTML = `
            <h6 class="mb-4 text-primary">
                <i class="fa fa-cogs me-2"></i>Stream Processor Service
            </h6>
            <div class="text-center">
                <i class="fa fa-spinner fa-spin fa-2x text-info mb-2"></i>
                <p class="text-muted">Refreshing status...</p>
            </div>
        `;
    }
    
    // Reload the page to get fresh status
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function showDeleteConfirmation() {
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
    modal.show();
}

function openComprehensiveSubmission(sourceId) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('comprehensiveSubmissionModal'));
    modal.show();

    // Reset modal state
    document.getElementById('comprehensiveSubmissionStatus').style.display = 'none';
    document.getElementById('comprehensiveSubmissionResult').style.display = 'none';
    document.getElementById('closeComprehensiveModalBtn').style.display = 'block';
    document.getElementById('submitComprehensiveBtn').style.display = 'block';
    document.getElementById('refreshComprehensivePageBtn').style.display = 'none';

    // Populate form with source data
    populateComprehensiveForm(sourceId);
}

function populateComprehensiveForm(sourceId) {
    // Get source data from the page context
    const sourceType = '{{ source_type }}';
    const sourceName = '{{ source.name }}';
    
    // Set basic fields
    document.getElementById('stream_id').value = '{{ source.source_id }}';
    document.getElementById('topic_name').value = '{{ source.topic_name|default:"" }}';
    
    // Set source URL based on type
    if (sourceType === 'camera') {
        document.getElementById('source_url').value = '{{ source.get_camera_url|default:"" }}';
        // Pre-populate camera-specific fields
        if ('{{ source.camera_username }}') {
            document.getElementById('username').value = '{{ source.camera_username }}';
        }
        if ('{{ source.camera_fps }}') {
            document.getElementById('target_fps').value = '{{ source.camera_fps }}';
        }
        if ('{{ source.camera_resolution_width }}' && '{{ source.camera_resolution_height }}') {
            document.getElementById('resize_enabled').checked = true;
            document.getElementById('target_width').value = '{{ source.camera_resolution_width }}';
            document.getElementById('target_height').value = '{{ source.camera_resolution_height }}';
            document.getElementById('target_width').disabled = false;
            document.getElementById('target_height').disabled = false;
        }
        if ('{{ source.camera_audio_enabled }}' === 'True') {
            document.getElementById('enable_audio').checked = true;
            if ('{{ source.camera_audio_codec }}') {
                document.getElementById('audio_codec').value = '{{ source.camera_audio_codec }}';
                document.getElementById('audio_codec').disabled = false;
            }
            if ('{{ source.camera_audio_channels }}') {
                document.getElementById('audio_channels').value = '{{ source.camera_audio_channels }}';
                document.getElementById('audio_channels').disabled = false;
            }
            if ('{{ source.camera_audio_sample_rate }}') {
                document.getElementById('audio_sample_rate').value = '{{ source.camera_audio_sample_rate }}';
                document.getElementById('audio_sample_rate').disabled = false;
            }
        }
        if ('{{ source.camera_buffer_size }}') {
            document.getElementById('buffer_size').value = '{{ source.camera_buffer_size }}';
        }
        if ('{{ source.camera_timeout }}') {
            document.getElementById('timeout').value = '{{ source.camera_timeout }}';
        }
        if ('{{ source.camera_retry_attempts }}') {
            document.getElementById('retry_attempts').value = '{{ source.camera_retry_attempts }}';
        }
        if ('{{ source.camera_keepalive }}' !== 'None') {
            document.getElementById('keepalive').checked = '{{ source.camera_keepalive }}' === 'True';
        }
    } else if (sourceType === 'stream') {
        document.getElementById('source_url').value = '{{ source.stream_url }}';
        if ('{{ source.stream_fps }}') {
            document.getElementById('target_fps').value = '{{ source.stream_fps }}';
        }
        if ('{{ source.stream_resolution_width }}' && '{{ source.stream_resolution_height }}') {
            document.getElementById('resize_enabled').checked = true;
            document.getElementById('target_width').value = '{{ source.stream_resolution_width }}';
            document.getElementById('target_height').value = '{{ source.stream_resolution_height }}';
            document.getElementById('target_width').disabled = false;
            document.getElementById('target_height').disabled = false;
        }
        if ('{{ source.stream_audio_codec }}') {
            document.getElementById('enable_audio').checked = true;
            document.getElementById('audio_codec').value = '{{ source.stream_audio_codec }}';
            document.getElementById('audio_codec').disabled = false;
        }
        if ('{{ source.stream_audio_channels }}') {
            document.getElementById('audio_channels').value = '{{ source.stream_audio_channels }}';
            document.getElementById('audio_channels').disabled = false;
        }
        if ('{{ source.stream_audio_sample_rate }}') {
            document.getElementById('audio_sample_rate').value = '{{ source.stream_audio_sample_rate }}';
            document.getElementById('audio_sample_rate').disabled = false;
        }
        if ('{{ source.stream_buffer_size }}') {
            document.getElementById('buffer_size').value = '{{ source.stream_buffer_size }}';
        }
        if ('{{ source.stream_timeout }}') {
            document.getElementById('timeout').value = '{{ source.stream_timeout }}';
        }
        if ('{{ source.stream_retry_attempts }}') {
            document.getElementById('retry_attempts').value = '{{ source.stream_retry_attempts }}';
        }
        if ('{{ source.stream_keepalive }}' !== 'None') {
            document.getElementById('keepalive').checked = '{{ source.stream_keepalive }}' === 'True';
        }
    }
    
    // Update modal title
    document.getElementById('comprehensiveSubmissionModalLabel').innerHTML = `
        <i class="fa fa-cogs me-2"></i>Comprehensive Stream Submission for ${sourceName}
    `;
}

// Add event listeners for form interactions
document.addEventListener('DOMContentLoaded', function() {
    // Handle resize enabled checkbox
    const resizeEnabled = document.getElementById('resize_enabled');
    const targetWidth = document.getElementById('target_width');
    const targetHeight = document.getElementById('target_height');
    
    if (resizeEnabled && targetWidth && targetHeight) {
        resizeEnabled.addEventListener('change', function() {
            targetWidth.disabled = !this.checked;
            targetHeight.disabled = !this.checked;
        });
    }
    
    // Handle audio enabled checkbox
    const enableAudio = document.getElementById('enable_audio');
    const audioCodec = document.getElementById('audio_codec');
    const audioChannels = document.getElementById('audio_channels');
    const audioSampleRate = document.getElementById('audio_sample_rate');
    
    if (enableAudio && audioCodec && audioChannels && audioSampleRate) {
        enableAudio.addEventListener('change', function() {
            audioCodec.disabled = !this.checked;
            audioChannels.disabled = !this.checked;
            audioSampleRate.disabled = !this.checked;
        });
    }
    
    // Handle comprehensive submission form submission
    const submitComprehensiveBtn = document.getElementById('submitComprehensiveBtn');
    if (submitComprehensiveBtn) {
        submitComprehensiveBtn.addEventListener('click', function() {
            submitComprehensiveStream('{{ source.source_id }}');
        });
    }
});

function submitComprehensiveStream(sourceId) {
    // Show loading state
    document.getElementById('comprehensiveSubmissionForm').style.display = 'none';
    document.getElementById('comprehensiveSubmissionStatus').style.display = 'block';
    document.getElementById('comprehensiveSubmissionResult').style.display = 'none';
    
    // Collect form data
    const formData = {
        stream_id: document.getElementById('stream_id').value,
        source_url: document.getElementById('source_url').value,
        topic_name: document.getElementById('topic_name').value,
        external_service_id: document.getElementById('external_service_id').value,
        target_fps: parseFloat(document.getElementById('target_fps').value),
        frame_quality: parseInt(document.getElementById('frame_quality').value),
        resize_enabled: document.getElementById('resize_enabled').checked,
        target_width: document.getElementById('resize_enabled').checked ? parseInt(document.getElementById('target_width').value) : null,
        target_height: document.getElementById('resize_enabled').checked ? parseInt(document.getElementById('target_height').value) : null,
        username: document.getElementById('username').value || null,
        password: document.getElementById('password').value || null,
        enable_audio: document.getElementById('enable_audio').checked,
        audio_codec: document.getElementById('enable_audio').checked ? document.getElementById('audio_codec').value : null,
        audio_channels: document.getElementById('enable_audio').checked ? parseInt(document.getElementById('audio_channels').value) : null,
        audio_sample_rate: document.getElementById('enable_audio').checked ? parseInt(document.getElementById('audio_sample_rate').value) : null,
        buffer_size: parseInt(document.getElementById('buffer_size').value),
        timeout: parseInt(document.getElementById('timeout').value),
        retry_attempts: parseInt(document.getElementById('retry_attempts').value),
        keepalive: document.getElementById('keepalive').checked,
        custom_metadata: document.getElementById('custom_metadata').value ? JSON.parse(document.getElementById('custom_metadata').value) : {}
    };
    
    // Submit to comprehensive endpoint
    fetch(`/source-management/api/stream/${sourceId}/submit-comprehensive/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading state
        document.getElementById('comprehensiveSubmissionStatus').style.display = 'none';
        document.getElementById('comprehensiveSubmissionResult').style.display = 'block';
        
        if (data.success) {
            // Show success
            document.getElementById('comprehensiveSuccessResult').style.display = 'block';
            document.getElementById('comprehensiveErrorResult').style.display = 'none';
            document.getElementById('comprehensiveSuccessMessage').textContent = data.message || 'Stream submitted successfully!';
            document.getElementById('closeComprehensiveModalBtn').style.display = 'none';
            document.getElementById('submitComprehensiveBtn').style.display = 'none';
            document.getElementById('refreshComprehensivePageBtn').style.display = 'block';
        } else {
            // Show error
            document.getElementById('comprehensiveSuccessResult').style.display = 'none';
            document.getElementById('comprehensiveErrorResult').style.display = 'block';
            document.getElementById('comprehensiveErrorMessage').textContent = data.error || 'Unknown error occurred';
            document.getElementById('closeComprehensiveModalBtn').style.display = 'block';
            document.getElementById('submitComprehensiveBtn').style.display = 'block';
            document.getElementById('refreshComprehensivePageBtn').style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Hide loading state
        document.getElementById('comprehensiveSubmissionStatus').style.display = 'none';
        document.getElementById('comprehensiveSubmissionResult').style.display = 'block';
        
        // Show error
        document.getElementById('comprehensiveSuccessResult').style.display = 'none';
        document.getElementById('comprehensiveErrorResult').style.display = 'block';
        document.getElementById('comprehensiveErrorMessage').textContent = 'Network error. Please try again.';
        document.getElementById('closeComprehensiveModalBtn').style.display = 'block';
        document.getElementById('submitComprehensiveBtn').style.display = 'block';
        document.getElementById('refreshComprehensivePageBtn').style.display = 'none';
    });
}
</script>
{% endif %}

{% endblock %} 