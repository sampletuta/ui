{% extends 'base.html' %}

{% block title %}{{ source.name }} - {{ source_type|title }} Source{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-12">
            <div class="bg-secondary rounded h-100 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h6 class="mb-0">
                        <i class="fa fa-{% if source_type == 'camera' %}video-camera{% elif source_type == 'file' %}file-video{% elif source_type == 'stream' %}broadcast-tower{% else %}video{% endif %} me-2"></i>
                        {{ source.name }}
                    </h6>
                    <div class="d-flex gap-2">
                        <a href="{% url 'source_management:source_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="fa fa-arrow-left me-2"></i>Back to Sources
                        </a>
                        <a href="{% url 'source_management:'|add:source_type|add:'_update' source.source_id %}" class="btn btn-primary btn-sm">
                            <i class="fa fa-edit me-2"></i>Edit
                        </a>
                    </div>
                </div>

                <!-- Source Information -->
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="bg-dark rounded p-4">
                            <h6 class="mb-4 text-primary">
                                <i class="fa fa-info-circle me-2"></i>Source Details
                            </h6>
                            
                            <div class="table-responsive">
                                <table class="table table-borderless text-white">
                                    <tbody>
                                        <tr>
                                            <td><strong>Source ID:</strong></td>
                                            <td><code class="text-info">{{ source.source_id }}</code></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Name:</strong></td>
                                            <td>{{ source.name }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Type:</strong></td>
                                            <td>
                                                {% if source_type == 'camera' %}
                                                    <span class="badge bg-primary">Camera</span>
                                                {% elif source_type == 'file' %}
                                                    <span class="badge bg-success">File</span>
                                                {% elif source_type == 'stream' %}
                                                    <span class="badge bg-info">Stream</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Status:</strong></td>
                                            <td>
                                                {% if source.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% if source.description %}
                                        <tr>
                                            <td><strong>Description:</strong></td>
                                            <td>{{ source.description }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if source.location %}
                                        <tr>
                                            <td><strong>Location:</strong></td>
                                            <td>{{ source.location }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if source.zone %}
                                        <tr>
                                            <td><strong>Zone:</strong></td>
                                            <td>{{ source.zone }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <td><strong>Created:</strong></td>
                                            <td>{{ source.created_at|date:"F d, Y H:i" }}</td>
                                        </tr>
                                        {% if source.updated_at %}
                                        <tr>
                                            <td><strong>Last Updated:</strong></td>
                                            <td>{{ source.updated_at|date:"F d, Y H:i" }}</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>

                            <!-- Source Type Specific Information -->
                            {% if source_type == 'camera' %}
                            <div class="mt-4">
                                <h6 class="mb-3 text-primary">
                                    <i class="fa fa-video-camera me-2"></i>Camera Configuration
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-borderless text-white">
                                        <tbody>
                                            <tr>
                                                <td><strong>IP Address:</strong></td>
                                                <td><code class="text-info">{{ source.camera_ip }}</code></td>
                                            </tr>
                                            {% if source.camera_port %}
                                            <tr>
                                                <td><strong>Port:</strong></td>
                                                <td>{{ source.camera_port }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_protocol %}
                                            <tr>
                                                <td><strong>Protocol:</strong></td>
                                                <td>{{ source.camera_protocol }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_username %}
                                            <tr>
                                                <td><strong>Username:</strong></td>
                                                <td>{{ source.camera_username }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_type %}
                                            <tr>
                                                <td><strong>Camera Type:</strong></td>
                                                <td>{{ source.camera_type }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_resolution %}
                                            <tr>
                                                <td><strong>Resolution:</strong></td>
                                                <td>{{ source.camera_resolution }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.camera_fps %}
                                            <tr>
                                                <td><strong>Frame Rate:</strong></td>
                                                <td>{{ source.camera_fps }} FPS</td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}

                            {% if source_type == 'file' %}
                            <div class="mt-4">
                                <h6 class="mb-3 text-primary">
                                    <i class="fa fa-file-video me-2"></i>File Information
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-borderless text-white">
                                        <tbody>
                                            <tr>
                                                <td><strong>Original Filename:</strong></td>
                                                <td><code class="text-info">{{ source.original_filename|default:"Not specified" }}</code></td>
                                            </tr>
                                            <tr>
                                                <td><strong>File Size:</strong></td>
                                                <td>{{ source.get_file_size_display|default:"Not specified" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>File Format:</strong></td>
                                                <td>{{ source.file_format|default:"Not specified" }}</td>
                                            </tr>
                                            {% if source.access_token %}
                                            <tr>
                                                <td><strong>Access Token:</strong></td>
                                                <td><code class="text-info">{{ source.access_token }}</code></td>
                                            </tr>
                                            {% endif %}
                                            {% if source.status %}
                                            <tr>
                                                <td><strong>Processing Status:</strong></td>
                                                <td>
                                                    {% if source.status == 'ready' %}
                                                        <span class="badge bg-success">Ready</span>
                                                    {% elif source.status == 'processing' %}
                                                        <span class="badge bg-warning">Processing</span>
                                                    {% elif source.status == 'failed' %}
                                                        <span class="badge bg-danger">Failed</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ source.status|title }}</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}

                            {% if source_type == 'stream' %}
                            <div class="mt-4">
                                <h6 class="mb-3 text-primary">
                                    <i class="fa fa-broadcast-tower me-2"></i>Stream Configuration
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-borderless text-white">
                                        <tbody>
                                            <tr>
                                                <td><strong>Stream URL:</strong></td>
                                                <td><code class="text-info">{{ source.stream_url }}</code></td>
                                            </tr>
                                            {% if source.stream_protocol %}
                                            <tr>
                                                <td><strong>Protocol:</strong></td>
                                                <td>{{ source.stream_protocol }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.stream_quality %}
                                            <tr>
                                                <td><strong>Quality:</strong></td>
                                                <td>{{ source.stream_quality }}</td>
                                            </tr>
                                            {% endif %}
                                            {% if source.stream_parameters %}
                                            <tr>
                                                <td><strong>Parameters:</strong></td>
                                                <td><code class="text-info">{{ source.stream_parameters }}</code></td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <!-- Location Information -->
                        {% if source.latitude and source.longitude %}
                        <div class="bg-dark rounded p-4 mb-4">
                            <h6 class="mb-4 text-primary">
                                <i class="fa fa-map me-2"></i>Location
                            </h6>
                            <div class="text-center">
                                <i class="fa fa-map fa-2x text-primary mb-2"></i>
                                <p class="text-muted mb-2">Coordinates</p>
                                <p class="mb-2">
                                    <strong>Lat:</strong> {{ source.latitude|floatformat:6 }}<br>
                                    <strong>Lng:</strong> {{ source.longitude|floatformat:6 }}
                                </p>
                                <a href="https://maps.google.com/?q={{ source.latitude }},{{ source.longitude }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fa fa-external-link-alt me-2"></i>View on Map
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Quick Actions -->
                        <div class="bg-dark rounded p-4">
                            <h6 class="mb-4 text-primary">
                                <i class="fa fa-bolt me-2"></i>Quick Actions
                            </h6>
                            <div class="d-grid gap-2">
                                {% if source_type == 'file' and source.status == 'ready' %}
                                <a href="{% url 'video_player:source_video_detail' source.source_id %}" class="btn btn-success">
                                    <i class="fa fa-play me-2"></i>Play Video
                                </a>
                                {% elif source_type == 'camera' and source.is_active %}
                                <a href="{% url 'video_player:source_video_detail' source.source_id %}" class="btn btn-success">
                                    <i class="fa fa-video me-2"></i>View Live Stream
                                </a>
                                {% elif source_type == 'stream' %}
                                <a href="{% url 'video_player:source_video_detail' source.source_id %}" class="btn btn-success">
                                    <i class="fa fa-broadcast-tower me-2"></i>View Stream
                                </a>
                                {% endif %}
                                <a href="{% url 'source_management:'|add:source_type|add:'_update' source.source_id %}" class="btn btn-primary">
                                    <i class="fa fa-edit me-2"></i>Edit Source
                                </a>
                                <a href="{% url 'source_management:'|add:source_type|add:'_delete' source.source_id %}" class="btn btn-danger">
                                    <i class="fa fa-trash me-2"></i>Delete Source
                                </a>
                            </div>
                        </div>

                        <!-- Stream Processor Service Status -->
                        {% if source_type in 'camera,stream' and processor_status %}
                        <div class="bg-dark rounded p-4 mt-4">
                            <h6 class="mb-4 text-primary">
                                <i class="fa fa-cogs me-2"></i>Stream Processor Service
                            </h6>
                            {% if processor_status.success %}
                                <div class="text-success mb-2">
                                    <i class="fa fa-check-circle me-2"></i>Connected
                                </div>
                                {% if processor_status.data %}
                                    <div class="small text-muted">
                                        <div><strong>Status:</strong> {{ processor_status.data.status|default:"Unknown" }}</div>
                                        {% if processor_status.data.topic_name %}
                                        <div><strong>Topic:</strong> {{ processor_status.data.topic_name }}</div>
                                        {% endif %}
                                        {% if processor_status.data.frames_ingested is not None %}
                                        <div><strong>Frames:</strong> {{ processor_status.data.frames_ingested }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                
                                <!-- Stream Control Buttons -->
                                <div class="mt-3">
                                    <div class="d-grid gap-2">
                                        {% if processor_status.data.status == 'running' %}
                                            <button class="btn btn-warning btn-sm" onclick="stopStream('{{ source.source_id }}')">
                                                <i class="fa fa-stop me-2"></i>Stop Stream
                                            </button>
                                        {% else %}
                                            <button class="btn btn-success btn-sm" onclick="startStream('{{ source.source_id }}')">
                                                <i class="fa fa-play me-2"></i>Start Stream
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-outline-primary btn-sm" onclick="submitStream('{{ source.source_id }}')">
                                            <i class="fa fa-paper-plane me-2"></i>Submit Stream Data
                                        </button>
                                        <button class="btn btn-info btn-sm" onclick="refreshStreamStatus('{{ source.source_id }}')">
                                            <i class="fa fa-refresh me-2"></i>Refresh Status
                                        </button>
                                    </div>
                                </div>
                            {% elif processor_status.not_found %}
                                <div class="text-info mb-2">
                                    <i class="fa fa-info-circle me-2"></i>Not Registered
                                </div>
                                <div class="small text-muted mb-3">
                                    This source is not yet registered with the stream processor service.
                                </div>
                                <div class="mt-3">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary btn-sm" onclick="createStream('{{ source.source_id }}')">
                                            <i class="fa fa-plus me-2"></i>Register with Processor Service
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm" onclick="submitStream('{{ source.source_id }}')">
                                            <i class="fa fa-paper-plane me-2"></i>Submit Stream Data
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-warning mb-2">
                                    <i class="fa fa-exclamation-triangle me-2"></i>Connection Failed
                                </div>
                                <div class="small text-muted">
                                    {{ processor_status.error|default:"Unknown error" }}
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-info btn-sm" onclick="refreshStreamStatus('{{ source.source_id }}')">
                                        <i class="fa fa-refresh me-2"></i>Retry Connection
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stream Submission Modal -->
<div class="modal fade" id="streamSubmissionModal" tabindex="-1" aria-labelledby="streamSubmissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="streamSubmissionModalLabel">Stream Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="submissionStatus">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 mb-0">Submitting stream data...</p>
                    </div>
                </div>
                <div id="submissionResult" style="display: none;">
                    <div id="successResult" style="display: none;">
                        <div class="alert alert-success">
                            <i class="fa fa-check-circle me-2"></i>
                            <span id="successMessage"></span>
                        </div>
                    </div>
                    <div id="errorResult" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="fa fa-exclamation-circle me-2"></i>
                            <span id="errorMessage"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closeModalBtn">Close</button>
                <button type="button" class="btn btn-primary" id="refreshPageBtn" style="display: none;">Refresh Page</button>
            </div>
        </div>
    </div>
</div>

<!-- Stream Control JavaScript -->
{% if source_type in 'camera,stream' %}
<script>
// Reset modal when it's closed
document.getElementById('streamSubmissionModal').addEventListener('hidden.bs.modal', function () {
    // Reset modal title and content
    document.getElementById('streamSubmissionModalLabel').textContent = 'Stream Submission';
    document.querySelector('#submissionStatus p').textContent = 'Submitting stream data...';
    
    // Reset modal state
    document.getElementById('submissionStatus').style.display = 'block';
    document.getElementById('submissionResult').style.display = 'none';
    document.getElementById('closeModalBtn').style.display = 'block';
    document.getElementById('refreshPageBtn').style.display = 'none';
});

function startStream(sourceId) {
    if (confirm('Start video stream processing for this source?')) {
        fetch(`/source-management/api/stream/${sourceId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh to show updated status
            } else {
                alert('Failed to start stream: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting stream. Please try again.');
        });
    }
}

function stopStream(sourceId) {
    if (confirm('Stop video stream processing for this source?')) {
        fetch(`/source-management/api/stream/${sourceId}/stop/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Refresh to show updated status
            } else {
                alert('Failed to stop stream: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error stopping stream. Please try again.');
        });
    }
}

function createStream(sourceId) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('streamSubmissionModal'));
    modal.show();
    
    // Update modal title and content for registration
    document.getElementById('streamSubmissionModalLabel').textContent = 'Stream Registration';
    document.querySelector('#submissionStatus p').textContent = 'Registering with processor service...';
    
    // Reset modal state
    document.getElementById('submissionStatus').style.display = 'block';
    document.getElementById('submissionResult').style.display = 'none';
    document.getElementById('closeModalBtn').style.display = 'block';
    document.getElementById('refreshPageBtn').style.display = 'none';
    
    // Register the stream
    fetch(`/source-management/api/stream/${sourceId}/create/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading status
        document.getElementById('submissionStatus').style.display = 'none';
        document.getElementById('submissionResult').style.display = 'block';
        
        if (data.success) {
            // Show success
            document.getElementById('successResult').style.display = 'block';
            document.getElementById('errorResult').style.display = 'none';
            document.getElementById('successMessage').textContent = data.message || 'Stream registered successfully!';
            document.getElementById('closeModalBtn').style.display = 'none';
            document.getElementById('refreshPageBtn').style.display = 'block';
        } else {
            // Show error
            document.getElementById('successResult').style.display = 'none';
            document.getElementById('errorResult').style.display = 'block';
            document.getElementById('errorMessage').textContent = data.error || 'Unknown error occurred';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Hide loading status
        document.getElementById('submissionStatus').style.display = 'none';
        document.getElementById('submissionResult').style.display = 'block';
        
        // Show error
        document.getElementById('successResult').style.display = 'none';
        document.getElementById('errorResult').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'Network error. Please try again.';
    });
}

function submitStream(sourceId) {
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('streamSubmissionModal'));
    modal.show();
    
    // Reset modal state
    document.getElementById('submissionStatus').style.display = 'block';
    document.getElementById('submissionResult').style.display = 'none';
    document.getElementById('closeModalBtn').style.display = 'block';
    document.getElementById('refreshPageBtn').style.display = 'none';
    
    // Submit the stream data
    fetch(`/source-management/api/stream/${sourceId}/submit/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading status
        document.getElementById('submissionStatus').style.display = 'none';
        document.getElementById('submissionResult').style.display = 'block';
        
        if (data.success) {
            // Show success
            document.getElementById('successResult').style.display = 'block';
            document.getElementById('errorResult').style.display = 'none';
            document.getElementById('successMessage').textContent = data.message || 'Stream data submitted successfully!';
            document.getElementById('closeModalBtn').style.display = 'none';
            document.getElementById('refreshPageBtn').style.display = 'block';
        } else {
            // Show error
            document.getElementById('successResult').style.display = 'none';
            document.getElementById('errorResult').style.display = 'block';
            document.getElementById('errorMessage').textContent = data.error || 'Unknown error occurred';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Hide loading status
        document.getElementById('submissionStatus').style.display = 'none';
        document.getElementById('submissionResult').style.display = 'block';
        
        // Show error
        document.getElementById('successResult').style.display = 'none';
        document.getElementById('errorResult').style.display = 'block';
        document.getElementById('errorMessage').textContent = 'Network error. Please try again.';
    });
}

function refreshStreamStatus(sourceId) {
    // Show loading state
    const statusDiv = document.querySelector('.bg-dark.rounded.p-4.mt-4');
    if (statusDiv) {
        statusDiv.innerHTML = `
            <h6 class="mb-4 text-primary">
                <i class="fa fa-cogs me-2"></i>Stream Processor Service
            </h6>
            <div class="text-center">
                <i class="fa fa-spinner fa-spin fa-2x text-info mb-2"></i>
                <p class="text-muted">Refreshing status...</p>
            </div>
        `;
    }
    
    // Reload the page to get fresh status
    setTimeout(() => {
        location.reload();
    }, 1000);
}
</script>
{% endif %}

{% endblock %} 