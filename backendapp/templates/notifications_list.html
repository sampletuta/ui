{% extends 'base.html' %}
{% load humanize %}
{% block content %}
<div class="container-fluid pt-4 px-4">
	<div class="bg-secondary rounded p-4">
		<div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-3 gap-2">
			<h5 class="mb-0">Notifications</h5>
            <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'mark_all_notifications_read' %}" class="btn btn-sm btn-primary">Mark all as read</a>
                <button type="button" class="btn btn-sm btn-outline-light" id="btn-clear-read">Clear read</button>
                <button type="button" class="btn btn-sm btn-outline-light" id="btn-clear-older-7">Clear older than 7 days</button>
                <button type="button" class="btn btn-sm btn-outline-light" id="btn-keep-100">Keep latest 100 (read)</button>
                <button type="button" class="btn btn-sm btn-outline-danger" id="btn-clear-all">Clear all</button>
            </div>
		</div>
        {% if notifications and notifications|length > 0 %}
			<div class="table-responsive">
				<table class="table table-dark table-hover align-middle mb-0">
					<thead>
						<tr>
							<th scope="col">Status</th>
							<th scope="col">Notification</th>
							<th scope="col">When</th>
							<th scope="col" class="text-end">Action</th>
						</tr>
					</thead>
					<tbody>
						{% for n in notifications %}
						<tr>
							<td>{% if n.unread %}<span class="badge bg-primary">New</span>{% else %}<span class="badge bg-secondary">Read</span>{% endif %}</td>
							<td>
                                <a href="{% url 'notification_detail' n.id %}" class="text-decoration-none text-light" data-notification-id="{{ n.id }}">
									{{ n.verb|capfirst }}
								</a>
							</td>
							<td><small class="text-muted">{{ n.timestamp|naturaltime }}</small></td>
							<td class="text-end">
                                <div class="btn-group">
                                    <a href="{% url 'notification_detail' n.id %}" class="btn btn-outline-light btn-sm">View</a>
                                    <button type="button" class="btn btn-outline-danger btn-sm btn-clear-one" data-notification-id="{{ n.id }}" title="Remove">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
							</td>
						</tr>
						{% endfor %}
					</tbody>
                </table>
			</div>
            <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
                <div>
                    <form method="get" class="d-inline-block">
                        {% if request.GET.page %}<input type="hidden" name="page" value="{{ request.GET.page }}">{% endif %}
                        <label class="me-1"><small>Per page</small></label>
                        <select name="per_page" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">
                            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                        </select>
                    </form>
                </div>
                {% if page_obj and paginator.num_pages > 1 %}
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                            <a class="page-link" href="?page=1&per_page={{ per_page }}">« First</a>
                        </li>
                        <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                            {% if page_obj.has_previous %}
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}">‹ Prev</a>
                            {% else %}
                            <a class="page-link" href="#">‹ Prev</a>
                            {% endif %}
                        </li>
                        {% for p in page_range %}
                        <li class="page-item {% if p == page_obj.number %}active{% endif %}"><a class="page-link" href="?page={{ p }}&per_page={{ per_page }}">{{ p }}</a></li>
                        {% endfor %}
                        <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                            {% if page_obj.has_next %}
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}">Next ›</a>
                            {% else %}
                            <a class="page-link" href="#">Next ›</a>
                            {% endif %}
                        </li>
                        <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                            <a class="page-link" href="?page={{ paginator.num_pages }}&per_page={{ per_page }}">Last »</a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </div>
		{% else %}
			<p class="text-light mb-0">No notifications.</p>
        {% endif %}
        <script>
        (function(){
            function post(url, data, cb){
                var xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
                var m = document.cookie.match('(?:^|; )csrftoken=([^;]*)');
                var token = m ? decodeURIComponent(m[1]) : '';
                xhr.setRequestHeader('X-CSRFToken', token);
                xhr.onreadystatechange = function(){ if (xhr.readyState === 4) { if (cb) cb(xhr); } };
                var body = Object.keys(data).map(function(k){ return encodeURIComponent(k)+'='+encodeURIComponent(data[k]); }).join('&');
                xhr.send(body);
            }
            function decrementBadge(){
                var badge = document.querySelector('.live_notify_badge');
                if (!badge) return;
                var current = parseInt((badge.textContent||'').trim(), 10);
                if (!isNaN(current) && current > 0) {
                    var next = current - 1;
                    badge.textContent = next > 0 ? String(next) : '';
                }
            }
            document.addEventListener('click', function(e){
                if (e.target.closest && e.target.closest('#btn-clear-all')){
                    post('{% url "clear_notifications" %}', { action: 'all' }, function(){ location.reload(); });
                }
                if (e.target.closest && e.target.closest('#btn-clear-read')){
                    post('{% url "clear_notifications" %}', { action: 'read' }, function(){ location.reload(); });
                }
                if (e.target.closest && e.target.closest('#btn-clear-older-7')){
                    post('{% url "clear_notifications" %}', { action: 'older_than_days', days: 7 }, function(){ location.reload(); });
                }
                if (e.target.closest && e.target.closest('#btn-keep-100')){
                    post('{% url "clear_notifications" %}', { action: 'keep_latest', keep: 100, scope: 'read' }, function(){ location.reload(); });
                }
                var clearOneBtn = e.target.closest && e.target.closest('.btn-clear-one');
                if (clearOneBtn){
                    var nid = clearOneBtn.getAttribute('data-notification-id');
                    if (!nid) return;
                    post('{% url "mark_notification_read" %}', { id: nid }, function(){
                        var row = clearOneBtn.closest('tr');
                        if (row) row.parentNode.removeChild(row);
                        decrementBadge();
                    });
                }
            });
        })();
        </script>
	</div>
</div>
{% endblock %}

